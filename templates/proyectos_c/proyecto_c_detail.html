{% extends 'base.html' %}
{% load project_extras %}
{% block page_content %}

<style>
    .gantt .bar-progress {
        fill: #60a5fa; /* Un azul más moderno */
    }
    .gantt .bar-label {
        font-size: 14px;
        font-weight: 500;
        fill: #1f2937;
    }
    .gantt .bar-wrapper:hover .bar {
        opacity: 0.8;
    }
    /* Oculta las tareas que usamos para definir el rango */
    .gantt .bar-wrapper.hidden-task {
        display: none;
    }
    /* Estilos para el contenedor del Gantt para permitir el scroll horizontal */
    #gantt-container-wrapper {
        overflow-x: auto; /* Habilita el slider horizontal */
        padding: 1rem;
        background-color: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
    }
    /* --- INICIO: AÑADE ESTOS ESTILOS PARA EL ASPECTO DE SOLO LECTURA --- */
    .gantt .bar-wrapper {
        cursor: not-allowed; /* Muestra un cursor de 'acción no permitida' */
    }
    .gantt .handle {
        display: none; /* Oculta los círculos para redimensionar/cambiar progreso */
    }
    /* --- FIN: AÑADE ESTOS ESTILOS --- */
</style>

<div class="bg-white p-6 rounded-lg shadow-md w-full md:w-3/4 lg:w-3/4"> <h1 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-4">Proyecto CC</h1>

    <div class="space-y-4">
        <div>
            <label class="block text-sm font-medium text-gray-500">Código</label>
            <p id="display-codigo" class="mt-1 text-lg text-gray-900">{{proyecto.codigo}}</p>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-500">Title</label>
            <p id="display-title" class="mt-1 text-lg text-gray-900">{{proyecto.title}}</p>
        </div>
         <div>
            <label class="block text-sm font-medium text-gray-500">Especificador(es)</label>
            <div id="display-especificador" class="mt-1 flex flex-wrap gap-2">
               {% for x in proyecto.proyectos_CC_especificador_relation.all %}
                <span class="bg-green-100 text-green-800 text-sm font-medium px-2.5 py-0.5 rounded">{{x.especificador.iniciales}}</span>
                {% endfor %}
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-500">Estimador(es)</label>
            <div id="display-estimador" class="mt-1 flex flex-wrap gap-2">
                {% for x in proyecto.proyectos_CC_estimador_relation.all %}
                <span class="bg-green-100 text-green-800 text-sm font-medium px-2.5 py-0.5 rounded">{{x.estimador.initials}}</span>
                {% endfor %}
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-500">Estimado Conceptual:</label>
            <div id="display-connceptual" class="mt-1 flex flex-wrap gap-2">
                {% for rel in proyecto.proyectos_CC_estimado_conceptual_cc.all %}
                <a href="{% url 'proyectos_e:proyecto_e_detail' pk=rel.estimado_conceptual.pk %}">
                <span class="bg-green-100 text-green-800 text-sm font-medium px-2.5 py-0.5 rounded">
                    {{ rel.estimado_conceptual.codigo }}</span>
                    </a>
                    {% endfor %}
            </div>
        </div>

        <div class="space-y-4 mt-6">
            <div>
                <label class="block text-sm font-medium text-gray-500">Coordinador</label>
                <p id="display-coordinador" class="mt-1 text-lg text-gray-900">{{proyecto.coordinador}}</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-500">Seccion</label>
                <p id="display-seccion" class="mt-1 text-lg text-gray-900">{{proyecto.seccion}}</p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-500">Comentarios</label>
                <p id="display-comentarios" class="mt-1 text-gray-700 bg-gray-50 p-3 rounded border border-gray-200">{{proyecto.comentarios}}</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-500">Status</label>
                <p id="display-status" class="mt-1 text-lg text-gray-900">
                    <span class="
                        px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full
                        {% if proyecto.get_estado_display == 'Adjudicado' %} bg-green-100 text-green-800
                        {% elif proyecto.get_estado_display == 'Cancelado' %} bg-red-100 text-red-800
                        {% elif proyecto.get_estado_display == 'Ingenieria' %} bg-blue-100 text-blue-800
                        {% else %} bg-gray-100 text-gray-800
                        {% endif %}
                    ">
                        {{ proyecto.get_estado_display }}
                    </span>
                </p>
            </div>
            
            <div class="mt-4">
                <button id="open-mf-modal" type="button" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-list-alt mr-2"></i> Ver Secciones MasterFormat
                </button>
            </div>
            </div>

        <div class="pt-4 border-t mt-4">
            <h3 class="text-lg font-medium text-gray-800 mb-2">Proyecto Master</h3>
            <div class="space-y-2">
                <div>
                    <span class="text-sm font-medium text-gray-500">Lista Master:</span>
                    <span class="ml-2 text-gray-900">
                        {% if proyecto.master_proyectos.all %}
                            <span class="bg-green-100 text-green-800 text-sm font-medium px-2.5 py-0.5 rounded">Sí</span>
                        {% else %}
                             <span class="bg-red-100 text-red-800 text-sm font-medium px-2.5 py-0.5 rounded">No</span>
                        {% endif %}
                    </span>
                </div>
                
                {% for master in proyecto.master_proyectos.all %}
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-500">Unidad Solicitante:</label>
                                <p class="text-sm text-gray-900">{{ master.unidad_solicitante }}</p>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">Año Fiscal:</label>
                                <p class="text-sm text-gray-900">{{ master.fiscal_year }}</p>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

         <div>
            <label class="block text-sm font-medium text-gray-500">Licitación RFQ:</label>
            <div id="display-licitacion" class="mt-1 flex flex-wrap gap-4"> {% for licitacion_rel in proyecto.proyecto_cc_licitacion_set.all %}
                <div class="flex flex-col items-start space-y-1">
                    <a href="{% url 'licitaciones:licitaciones_detail' pk=licitacion_rel.licitacion.pk %}">
                        <span class="bg-blue-100 text-blue-800 text-sm font-medium px-2.5 py-0.5 rounded hover:bg-blue-200 transition-colors">
                            {{ licitacion_rel.licitacion.rfq }}
                        </span>
                    </a>
                    <br />
                    {% with estado=licitacion_rel.licitacion.get_estado_lic_display %}
                    <span class="text-xs font-medium px-2 py-0.5 rounded-full
                        {% if estado == 'Adjudicacion' %} bg-green-100 text-green-800
                        {% elif estado == 'Acto Desierto' or estado == 'Cancelacion Del Acto' %} bg-red-100 text-red-800
                        {% elif estado == 'Evaluacion' or estado == 'En Preparacion' %} bg-blue-100 text-blue-800
                        {% elif estado == 'Abiertas' %} bg-yellow-100 text-yellow-800
                        {% elif estado == 'Anuncio Vencido' %} bg-amber-100 text-amber-800
                        {% elif estado == 'Enmendada' %} bg-indigo-100 text-indigo-800
                        {% else %} bg-gray-100 text-gray-800
                        {% endif %}
                    ">
                        {{ estado }}
                    </span>
                    {% endwith %}
                </div>
                {% empty %}
                <p class="text-gray-500">No hay licitaciones asociadas.</p>
                {% endfor %}
            </div>
        </div>

        {% for licitacion_rel in proyecto.proyecto_cc_licitacion_set.all %}
        {% if licitacion_rel.licitacion.contratos.exists %}
                            <div class="ml-4 mt-2">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Contratos:</label>
                                <div class="space-y-1">
                                    {% for contrato in licitacion_rel.licitacion.contratos.all %}
                                        <div class="flex items-center justify-between bg-white p-2 rounded border border-gray-200">
                                            <div class="flex items-center space-x-2">
                                                <span class="bg-purple-100 text-purple-800 text-xs font-medium px-2.5 py-0.5 rounded">
                                                    {{ contrato.numero_contrato }}
                                                </span>
                                              
                                            </div>
                                            </div>
                                            {% endfor %}
                                            </div>
                            </div>
        {% endif%}
        {% endfor %}

        <div>
        <label class="block text-sm font-medium text-gray-500">SIA:</label>
        <div class="mt-2 overflow-x-auto">
            <table class="min-w-full leading-normal shadow-md rounded-lg">
                <thead>
                    <tr>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Numero
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Nombre Proyecto
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Horas Cargadas
                        </th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Horas Presupuestadas
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for sia_rel in proyecto.proyecto_cc_sia_set.all %}
                    <tr>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <p class="text-gray-900 whitespace-no-wrap">
                                {{ sia_rel.sia.CodProyecto }}
                            </p>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <p class="text-gray-900 whitespace-no-wrap">
                                {{ sia_rel.sia.NomProyecto }}
                            </p>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <p class="text-gray-900 whitespace-no-wrap">
                                {{sia_rel.sia.HorasTotales |floatformat:2}}
                            </p>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <p class="text-gray-900 whitespace-no-wrap">
                                {# Aquí irán las Horas Presupuestadas cuando estén disponibles #}
                            </p>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-center" colspan="4">
                            <p class="text-gray-500 whitespace-no-wrap">No hay proyectos SIA asociados.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="mt-6">
            <label class="block text-sm font-medium text-gray-500">Horas por Rol SIA:</label>
            <div class="mt-2 overflow-x-auto">
                <table class="min-w-full leading-normal shadow-md rounded-lg">
                    <thead>
                        <tr>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Numero
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Nombre Proyecto
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Horas Cargadas Especificador
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Horas Cargadas Estimador
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sia_rel in proyecto.proyecto_cc_sia_set.all %}
                        <tr>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <p class="text-gray-900 whitespace-no-wrap">
                                    {{ sia_rel.sia.CodProyecto }}
                                </p>
                            </td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <p class="text-gray-900 whitespace-no-wrap">
                                    {{ sia_rel.sia.NomProyecto }}
                                </p>
                            </td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <p class="text-gray-900 whitespace-no-wrap">
                                    {{ sia_rel.sia.horas_especificador|floatformat:2 }}
                                </p>
                            </td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <p class="text-gray-900 whitespace-no-wrap">
                                    {{ sia_rel.sia.horas_estimador|floatformat:2 }}
                                </p>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-center" colspan="4">
                                <p class="text-gray-500 whitespace-no-wrap">No hay proyectos SIA asociados.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="pt-4">
        <label class="block text-sm font-medium text-gray-500 mb-2">Fechas Clave</label>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4 max-w-full">
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 min-w-0 max-w-xs">
                <p class="text-xs font-semibold text-gray-600 uppercase">Fecha de Entrada</p>
                <p class="text-lg font-medium text-gray-900 mt-1">
                    {% if proyecto.fecha_entrada %}
                        {{ proyecto.fecha_entrada|date:"d M Y" }}
                    {% else %}
                        <span class="text-gray-400 text-base">No especificada</span>
                    {% endif %}
                </p>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 min-w-0 max-w-xs">
                <p class="text-xs font-semibold text-gray-600 uppercase">Envío a FIO</p>
                <p class="text-lg font-medium text-gray-900 mt-1">
                    {% if proyecto.fecha_envio_FIO %}
                        {{ proyecto.fecha_envio_FIO|date:"d M Y" }}
                    {% else %}
                        <span class="text-gray-400 text-base">No especificada</span>
                    {% endif %}
                </p>
            </div>

            {% for master in proyecto.master_proyectos.all %}
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 min-w-0 max-w-xs">
                    <p class="text-xs font-semibold text-gray-600 uppercase">Fecha Estimada Entrega ({{ master.unidad_solicitante }})</p>
                    <p class="text-lg font-medium text-gray-900 mt-1">
                        {% if master.fecha_estimada_entrega_owner %}
                            {{ master.fecha_estimada_entrega_owner|date:"d M Y" }}
                        {% else %}
                            <span class="text-gray-400 text-base">No especificada</span>
                        {% endif %}
                    </p>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 min-w-0 max-w-xs">
                    <p class="text-xs font-semibold text-gray-600 uppercase">Fecha Bono</p>
                    <p class="text-lg font-medium text-gray-900 mt-1">
                        {% if master.fecha_estimada_entrega_owner %}
                            {{ master.fecha_estimada_entrega_owner|subtract_15_days|date:"d M Y" }}
                        {% else %}
                            <span class="text-gray-400 text-base">No especificada</span>
                        {% endif %}
                    </p>
                </div>


                {% endfor %}

            {% for licitacion_rel in proyecto.proyecto_cc_licitacion_set.all %}
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 min-w-0 max-w-xs">
                    <p class="text-xs font-semibold text-gray-600 uppercase">Pub. Licitación ({{ licitacion_rel.licitacion.rfq }})</p>
                    <p class="text-lg font-medium text-gray-900 mt-1">
                        {% if licitacion_rel.licitacion.publication_date %}
                           {{ licitacion_rel.licitacion.publication_date|date:"d M Y" }}
                        {% else %}
                            <span class="text-gray-400 text-base">No especificada</span>
                        {% endif %}
                    </p>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 min-w-0 max-w-xs">
                    <p class="text-xs font-semibold text-gray-600 uppercase">Cierre Licitación ({{ licitacion_rel.licitacion.rfq }})</p>
                    <p class="text-lg font-medium text-gray-900 mt-1">
                         {% if licitacion_rel.licitacion.closed_date %}
                           {{ licitacion_rel.licitacion.closed_date|date:"d M Y" }}
                        {% else %}
                            <span class="text-gray-400 text-base">No especificada</span>
                        {% endif %}
                    </p>
                </div>

                {% for contrato in licitacion_rel.licitacion.contratos.all %}
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 min-w-0 max-w-xs">
                        <p class="text-xs font-semibold text-gray-600 uppercase">Adjudicación ({{ contrato.numero_contrato }})</p>
                         <p class="text-lg font-medium text-gray-900 mt-1">
                            {% if contrato.fecha_adjudicacion %}
                               {{ contrato.fecha_adjudicacion|date:"d M Y" }}
                            {% else %}
                                <span class="text-gray-400 text-base">No especificada</span>
                            {% endif %}
                        </p>
                    </div>
                {% endfor %}
            {% endfor %}
        </div>
    </div>

    </div>

<div class="pt-4">
    <label class="block text-sm font-medium text-gray-500 mb-2">Duraciones Clave</label>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 max-w-full">

        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
            <p class="text-xs font-semibold text-gray-600 uppercase">Duración Diseño</p>
            <p class="text-lg font-medium text-gray-900 mt-1">
                {% if proyecto.fecha_envio_FIO and proyecto.fecha_entrada %}
                    {{ proyecto.fecha_envio_FIO|days_between:proyecto.fecha_entrada }} días
                {% else %}
                    <span class="text-gray-400 text-base">N/A</span>
                {% endif %}
            </p>
            <p class="text-xs text-gray-500">Entrada vs. Envío FIO</p>
        </div>

        {% for licitacion_rel in proyecto.proyecto_cc_licitacion_set.all %}
            
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <p class="text-xs font-semibold text-gray-600 uppercase">Duración en Contratos</p>
                <p class="text-lg font-medium text-gray-900 mt-1">
                    {% if licitacion_rel.licitacion.publication_date and proyecto.fecha_envio_FIO %}
                        {{ licitacion_rel.licitacion.publication_date|days_between:proyecto.fecha_envio_FIO }} días
                    {% else %}
                        <span class="text-gray-400 text-base">N/A</span>
                    {% endif %}
                </p>
                <p class="text-xs text-gray-500">Envío FIO vs. Publicación</p>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <p class="text-xs font-semibold text-gray-600 uppercase">Duración Licitación</p>
                <p class="text-lg font-medium text-gray-900 mt-1">
                    {% if licitacion_rel.licitacion.closed_date and licitacion_rel.licitacion.publication_date %}
                        {{ licitacion_rel.licitacion.closed_date|days_between:licitacion_rel.licitacion.publication_date }} días
                    {% else %}
                        <span class="text-gray-400 text-base">N/A</span>
                    {% endif %}
                </p>
                <p class="text-xs text-gray-500">Cierre vs. Publicación</p>
            </div>

            {% for contrato in licitacion_rel.licitacion.contratos.all %}
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <p class="text-xs font-semibold text-gray-600 uppercase">Duración Evaluación</p>
                    <p class="text-lg font-medium text-gray-900 mt-1">
                        {% if contrato.fecha_adjudicacion and licitacion_rel.licitacion.closed_date %}
                            {{ contrato.fecha_adjudicacion|days_between:licitacion_rel.licitacion.closed_date }} días
                        {% else %}
                            <span class="text-gray-400 text-base">N/A</span>
                        {% endif %}
                    </p>
                    <p class="text-xs text-gray-500">Adjudicación vs. Cierre</p>
                </div>
            {% endfor %} {% endfor %} </div>
</div>

    
   <div class="mt-8 pt-5 border-t">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center space-x-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    Línea de Tiempo del Proyecto
                </h3>
                <div class="flex items-center space-x-2">
                    <button id="gantt-view-day" class="gantt-view-btn px-3 py-1 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Día</button>
                    <button id="gantt-view-week" class="gantt-view-btn px-3 py-1 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Semana</button>
                    <button id="gantt-view-month" class="gantt-view-btn px-3 py-1 text-sm font-medium text-white bg-blue-600 rounded-md">Mes</button>
                </div>
            </div>
        </div>
        <div id="gantt-container-wrapper">
            </div>
    </div>


    

    <div class="mt-8 pt-5 border-t border-gray-200 flex justify-end space-x-3">
        <button id="update-button" type="button" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            Actualizar
        </button>
        <button id="delete-button" type="button" class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            Eliminar
        </button>
    </div>
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>

<div id="mf-modal" class="relative z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
  
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        
        <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl">
            
            <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4 border-b border-gray-200">
                <div class="sm:flex sm:items-start justify-between">
                    <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                        <h3 class="text-base font-semibold leading-6 text-gray-900" id="modal-title">Secciones MasterFormat</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">Listado detallado de Divisiones y Secciones extraídas.</p>
                        </div>
                    </div>
                    <button id="close-mf-modal-x" type="button" class="ml-auto inline-flex items-center justify-center rounded-md bg-white p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none ring-1 ring-inset ring-gray-300">
                        <span class="sr-only">Cerrar</span>
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="bg-gray-50 px-4 py-3 sm:px-6">
                <div class="flow-root">
                    <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                        <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                            <table class="min-w-full divide-y divide-gray-300">
                                <thead>
                                    <tr>
                                        <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">División</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Sección</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Descripción</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 bg-white">
                                    {% for item in proyecto.proyecto_cc_secciones_mf_set.all %}
                                    <tr>
                                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-0">{{ item.division }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{{ item.seccion }}</td>
                                        <td class="px-3 py-4 text-sm text-gray-500">{{ item.descripcion|default:"-" }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="3" class="py-4 text-center text-sm text-gray-500">
                                            No hay registros de secciones MasterFormat para este proyecto.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-gray-200">
                <button id="close-mf-modal-btn" type="button" class="inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cerrar</button>
            </div>
        </div>
      </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let gantt; // Variable para mantener la instancia del Gantt

        // --- Lógica para los botones de cambio de vista del Gantt ---
        const viewButtons = document.querySelectorAll('.gantt-view-btn');
        viewButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (gantt) {
                    const viewMode = button.id.split('-')[2]; // 'day', 'week', 'month'
                    const viewModeCapitalized = viewMode.charAt(0).toUpperCase() + viewMode.slice(1);
                    gantt.change_view_mode(viewModeCapitalized);
                    
                    // Actualizar estilos de los botones
                    viewButtons.forEach(btn => {
                        btn.classList.remove('bg-blue-600', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    button.classList.add('bg-blue-600', 'text-white');
                    button.classList.remove('bg-gray-200', 'text-gray-700');
                }
            });
        });

        // --- Función para inicializar el Gráfico Gantt ---
        function initializeGantt() {
            const ganttContainerWrapper = document.getElementById('gantt-container-wrapper');
            if (!ganttContainerWrapper) return;

            ganttContainerWrapper.innerHTML = '<p class="text-gray-500 text-center p-4">Cargando gráfico...</p>';
            const apiUrl = "{% url 'proyectos_c:proyecto_gantt_data' pk=proyecto.pk %}";

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error del servidor: ${response.status}`);
                    }
                    return response.json();
                })
                .then(tasks => {
                    ganttContainerWrapper.innerHTML = '<svg id="gantt"></svg>';
                    
                    if (tasks && tasks.length > 2) { 
                        gantt = new Gantt("#gantt", tasks, {
                            // --- INICIO: LÍNEAS PARA BLOQUEAR EL GRÁFICO ---
                            on_click: () => {},
                            on_date_change: () => {},
                            on_progress_change: () => {},
                            on_bar_resize: () => {},
                            // --- FIN: LÍNEAS PARA BLOQUEAR EL GRÁFICO ---
                            column_width: 28,
                            bar_height: 20,
                            custom_popup_html: function(task) {
                                const startDate = new Date(task._start).toLocaleDateString('es-ES');
                                const endDate = new Date(task._end).toLocaleDateString('es-ES');
                                return `
                                    <div class="p-2 bg-white rounded shadow-lg border">
                                        <h4 class="font-bold text-base mb-2">${task.name}</h4>
                                        <p class="mb-1"><strong>Inicio:</strong> ${startDate}</p>
                                        <p class="mb-1"><strong>Fin:</strong> ${endDate}</p>
                                        <p><strong>Progreso:</strong> ${task.progress}%</p>
                                    </div>
                                `;
                            },
                            language: 'es',
                            view_mode: 'Month',
                            view_modes: ['Day', 'Week', 'Month'],
                        });
                    } else {
                        ganttContainerWrapper.innerHTML = '<p class="text-gray-500 text-center p-4">No hay suficientes fechas para mostrar la línea de tiempo.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error al cargar los datos para el Gantt:', error);
                    ganttContainerWrapper.innerHTML = `<p class="text-red-500 text-center p-4">Ocurrió un error al cargar la línea de tiempo.<br><small>${error.message}</small></p>`;
                });
        }
        
        // Inicializar el Gantt en cuanto la página cargue
        initializeGantt();

        // --- LÓGICA MODAL SECCIONES MF (NUEVO) ---
        const modal = document.getElementById('mf-modal');
        const openBtn = document.getElementById('open-mf-modal');
        const closeBtn = document.getElementById('close-mf-modal-btn');
        const closeX = document.getElementById('close-mf-modal-x');

        function toggleModal(show) {
            if (show) {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Evita scroll trasero
            } else {
                modal.classList.add('hidden');
                document.body.style.overflow = ''; // Restaura scroll
            }
        }

        if (openBtn) openBtn.addEventListener('click', (e) => {
            e.preventDefault(); // Prevenir cualquier comportamiento extraño
            toggleModal(true);
        });

        if (closeBtn) closeBtn.addEventListener('click', () => toggleModal(false));
        if (closeX) closeX.addEventListener('click', () => toggleModal(false));
        
        // Cerrar al hacer click fuera (en el área oscura)
        // Nota: En esta nueva estructura, el click se detecta en el contenedor padre
        modal.addEventListener('click', function(event) {
             // Si el click es exactamente en el contenedor flex (la zona oscura alrededor del panel)
            if (event.target.closest('.relative.transform') === null && event.target === this.querySelector('.flex')) {
                toggleModal(false);
            }
        });
    });
</script>
{% endblock %}